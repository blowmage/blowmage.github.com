---
title:  Getting RubyGems to play nice at work
layout: post
desc:   I am so impressed with myself for hacking RubyGems that I announce it to the world.
tags:
  - ruby
---
<p>At work I'm on Windows and behind a proxy server. I recently wiped my workstation and started over. After I installed Ruby I found the gems command not working, again. The reason is that my proxy server requires a username and password, and open-uri doesn't pass them. (Supposedly because keeping your username and password in an environment variable isn't secure, but at work I don't care as much about apps snooping my environment variables.)</p>
<p>To get things working I had to hack up open-uri a bit.  So I found the following code in <code>C:\ruby\lib\ruby\1.8\open-uri.rb</code></p>

<pre class="textmate-source ruby_blue"><span class="source source_ruby">  <span class="meta meta_require meta_require_ruby"><span class="keyword keyword_other keyword_other_special-method keyword_other_special-method_ruby">require</span> <span class="string string_quoted string_quoted_single string_quoted_single_ruby"><span class="punctuation punctuation_definition punctuation_definition_string punctuation_definition_string_begin punctuation_definition_string_begin_ruby">'</span>net/http<span class="punctuation punctuation_definition punctuation_definition_string punctuation_definition_string_end punctuation_definition_string_end_ruby">'</span></span></span>
  klass <span class="keyword keyword_operator keyword_operator_assignment keyword_operator_assignment_ruby">=</span> <span class="support support_class support_class_ruby">Net</span><span class="punctuation punctuation_separator punctuation_separator_other punctuation_separator_other_ruby">::</span><span class="variable variable_other variable_other_constant variable_other_constant_ruby">HTTP</span>
  <span class="keyword keyword_control keyword_control_ruby">if</span> <span class="support support_class support_class_ruby">URI</span><span class="punctuation punctuation_separator punctuation_separator_other punctuation_separator_other_ruby">::</span><span class="variable variable_other variable_other_constant variable_other_constant_ruby">HTTP</span> <span class="keyword keyword_operator keyword_operator_comparison keyword_operator_comparison_ruby">===</span> target
<span class="comment comment_line comment_line_number-sign comment_line_number-sign_ruby">    <span class="punctuation punctuation_definition punctuation_definition_comment punctuation_definition_comment_ruby">#</span> HTTP or HTTPS
</span>    <span class="keyword keyword_control keyword_control_ruby">if</span> proxy
      klass <span class="keyword keyword_operator keyword_operator_assignment keyword_operator_assignment_ruby">=</span> <span class="support support_class support_class_ruby">Net</span><span class="punctuation punctuation_separator punctuation_separator_other punctuation_separator_other_ruby">::</span><span class="support support_class support_class_ruby">HTTP</span><span class="punctuation punctuation_separator punctuation_separator_other punctuation_separator_other_ruby">::</span><span class="variable variable_other variable_other_constant variable_other_constant_ruby">Proxy</span><span class="punctuation punctuation_section punctuation_section_function punctuation_section_function_ruby">(</span> proxy<span class="punctuation punctuation_separator punctuation_separator_method punctuation_separator_method_ruby">.</span>host<span class="punctuation punctuation_separator punctuation_separator_object punctuation_separator_object_ruby">,</span> proxy<span class="punctuation punctuation_separator punctuation_separator_method punctuation_separator_method_ruby">.</span>port<span class="punctuation punctuation_section punctuation_section_function punctuation_section_function_ruby">)</span>
    <span class="keyword keyword_control keyword_control_ruby">end</span></span></pre>

<p>And I make the following change:</p>

<pre class="textmate-source ruby_blue"><span class="source source_ruby">  <span class="meta meta_require meta_require_ruby"><span class="keyword keyword_other keyword_other_special-method keyword_other_special-method_ruby">require</span> <span class="string string_quoted string_quoted_single string_quoted_single_ruby"><span class="punctuation punctuation_definition punctuation_definition_string punctuation_definition_string_begin punctuation_definition_string_begin_ruby">'</span>net/http<span class="punctuation punctuation_definition punctuation_definition_string punctuation_definition_string_end punctuation_definition_string_end_ruby">'</span></span></span>
  klass <span class="keyword keyword_operator keyword_operator_assignment keyword_operator_assignment_ruby">=</span> <span class="support support_class support_class_ruby">Net</span><span class="punctuation punctuation_separator punctuation_separator_other punctuation_separator_other_ruby">::</span><span class="variable variable_other variable_other_constant variable_other_constant_ruby">HTTP</span>
  <span class="keyword keyword_control keyword_control_ruby">if</span> <span class="support support_class support_class_ruby">URI</span><span class="punctuation punctuation_separator punctuation_separator_other punctuation_separator_other_ruby">::</span><span class="variable variable_other variable_other_constant variable_other_constant_ruby">HTTP</span> <span class="keyword keyword_operator keyword_operator_comparison keyword_operator_comparison_ruby">===</span> target
<span class="comment comment_line comment_line_number-sign comment_line_number-sign_ruby">    <span class="punctuation punctuation_definition punctuation_definition_comment punctuation_definition_comment_ruby">#</span> HTTP or HTTPS
</span>    <span class="keyword keyword_control keyword_control_ruby">if</span> proxy
<span class="comment comment_line comment_line_number-sign comment_line_number-sign_ruby">      <span class="punctuation punctuation_definition punctuation_definition_comment punctuation_definition_comment_ruby">#</span> Add proxy user and password to work with the proxy server.
</span>      klass <span class="keyword keyword_operator keyword_operator_assignment keyword_operator_assignment_ruby">=</span> <span class="support support_class support_class_ruby">Net</span><span class="punctuation punctuation_separator punctuation_separator_other punctuation_separator_other_ruby">::</span><span class="support support_class support_class_ruby">HTTP</span><span class="punctuation punctuation_separator punctuation_separator_other punctuation_separator_other_ruby">::</span><span class="variable variable_other variable_other_constant variable_other_constant_ruby">Proxy</span><span class="punctuation punctuation_section punctuation_section_function punctuation_section_function_ruby">(</span>proxy<span class="punctuation punctuation_separator punctuation_separator_method punctuation_separator_method_ruby">.</span>host<span class="punctuation punctuation_separator punctuation_separator_object punctuation_separator_object_ruby">,</span> proxy<span class="punctuation punctuation_separator punctuation_separator_method punctuation_separator_method_ruby">.</span>port<span class="punctuation punctuation_separator punctuation_separator_object punctuation_separator_object_ruby">,</span> proxy<span class="punctuation punctuation_separator punctuation_separator_method punctuation_separator_method_ruby">.</span>user<span class="punctuation punctuation_separator punctuation_separator_object punctuation_separator_object_ruby">,</span> proxy<span class="punctuation punctuation_separator punctuation_separator_method punctuation_separator_method_ruby">.</span>password<span class="punctuation punctuation_section punctuation_section_function punctuation_section_function_ruby">)</span>
    <span class="keyword keyword_control keyword_control_ruby">end</span></span></pre>

<p>Then I create the <code>http_proxy</code> environment variable with the value of <code>http://blowmage:s3cr3t@proxy:8080</code> and I'm good to go. Well, I have to log off and log back in for Windows to find and RubyGems to use the new environment variable. Oh, and be sure to create it as a user variable and not a system variable. :)</p>